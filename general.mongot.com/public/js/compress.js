function chatNotifier(){"none"===$("#chatroom").css("display")&&($(".slide-toggle").addClass("chat-notifier"),setTimeout(function(){$(".slide-toggle").removeClass("chat-notifier")},3e3))}function startTimer(){var e,o,n=document.querySelector("#countdown"),t=120;clearInterval(countdown),countdown=setInterval(function(){e=parseInt(t/60,10),o=parseInt(t%60,10),e=e<10?"0"+e:e,o=o<10?"0"+o:o,n.textContent=e+":"+o,--t<0&&clearInterval(countdown)},1e3)}function showActivePlayer(e){playerEnabled=e.bool,activePlayer=e.player;var o=document.getElementById("user_color"),n=document.getElementById("username_turn");o.setAttribute("fill",e.color),n.textContent=e.username}function getCountry(e){for(var o=0;o<circles.length;o+=1)if(circles[o].country.id===parseInt(e))return circles[o]}function drawMap(){if(!$(".show-gold").is(":visible")){for(t=0;t<circles.length;t++){var e=document.getElementsByTagName("g")[circles[t].country.id],o=document.getElementsByTagName("circle")[circles[t].country.id],n=document.getElementsByTagName("text")[circles[t].country.id];o.setAttribute("fill","url(#radial_"+circles[t].color+")"),o.style["stroke-width"]="0",n.textContent=circles[t].country.units,n.setAttribute("fill","white"),e.id=circles[t].country.id}if(circles.length!==countriesGold.length)for(var t=0;t<disabledCountries.length;t++){var e=document.getElementsByTagName("g")[circles[t].country.id],o=document.getElementsByTagName("circle")[disabledCountries[t].id],n=document.getElementsByTagName("text")[disabledCountries[t].id];o.setAttribute("fill","grey"),o.style["stroke-width"]="0.5",o.style.stroke="white",n.textContent=disabledCountries[t].units,n.setAttribute("fill","white"),e.id=circles[t].country.id}}}function drawGold(){for(var e=0;e<countriesGold.length;e++){var o=document.getElementsByTagName("circle")[countriesGold[e].id],n=document.getElementsByTagName("text")[countriesGold[e].id];o.setAttribute("fill","gold"),n.setAttribute("fill","black"),n.textContent=countriesGold[e].gold}}function resizeImage(){var e=isMobile?32:0,o=$(window).height()-$("#game_header").height()-e,n=$(window).width();"none"!==$("#chatroom").css("display")&&(n-=$("#chatroom").width()),cont.css("height",.75*el.width()),cont.height()>o&&cont.css("height",o),isMobile||(el.removeAttr("style"),cont.height()<o&&cont.width()<n&&cont.css("height",o),el.width()>cont.width()&&el.css("width","auto"))}function battle(e,o){var n=getCountry(e);if(attackFrom&&n&&n.owner!==activePlayer){var t=getCountry(attackFrom);n.country.neighbour.indexOf(t.country.id)>-1&&t.country.units>1?(showUnitBar(t.country.units,e),o.find("circle").css({"stroke-width":"2.5",stroke:"lime"})):drawMap(),attackFrom=null,$("#unit_bar").submit(function(){return gameInfra.emit("battle",parseInt(t.country.id),parseInt(e),parseInt(n.owner),parseInt($("#unit_output").val())),$(".remove_unit_bar").remove(),!1})}n&&n.owner===activePlayer&&(drawMap(),$(".remove_unit_bar").remove(),o.find("circle").css({"stroke-width":"2.5",stroke:"white"}),attackFrom=e)}function tacticalMove(e,o){var n=getCountry(e);if(n.owner===activePlayer&&null==countryFrom&&(drawMap(),$(".remove_unit_bar").remove(),o.find("circle").css({"stroke-width":"2.5",stroke:"white"}),countryFrom=e),countryFrom&&n.owner===activePlayer&&e!==countryFrom){var t=getCountry(countryFrom);n.country.neighbour.indexOf(t.country.id)>-1&&t.country.units>1?(showUnitBar(t.country.units,e),o.find("circle").css({"stroke-width":"2.5",stroke:"lime"})):drawMap(),countryFrom=null,$("#unit_bar").submit(function(){return gameInfra.emit("tactical_move",parseInt(t.country.id),parseInt(e),parseInt(n.owner),parseInt($("#unit_output").val())),$(".remove_unit_bar").remove(),!1})}}function showUnitBar(e,o){if(e-=1,$(".remove_unit_bar").remove(),isMobile){$(".svg-container").after('<div class="remove_unit_bar range-unit-bar"><form id="unit_bar"><input type="range" id="unit_input" value="1" min="1" max="'+e+'" oninput="unit_output.value = unit_input.value"><output id="unit_output">1</output><input type="submit" value="Send Units" id="send_units"></form></div>');var n=8*e;$('#unit_bar input[type="range"]').css("width",n+"%")}else{var t=$("#"+o).find("circle").attr("cy"),a=$("#"+o).find("circle").attr("cx"),i=(t=parseInt(t)-135)/859.25*100,r=(a=parseInt(a)-55)/1147.148*100;$(".svg-container").append('<form class="remove_unit_bar input-unit-bar" id="unit_bar" style="top: '+i+"%; left: "+r+'%"><input type="text" value="1" id="unit_output" class="example-color" autocomplete="off" min="1" max="'+e+'"/><input type="submit" value="V" id="send_units"><input type="button" value="X" id="cancel_units"></form>');var s=$("#unit_output");s.before('<span class="sub">-</span>'),s.before('<span class="add">+</span>'),s.parent().on("click",".sub",function(){if(s.val()>parseInt(s.attr("min")))s.val(function(e,o){return--o});else if("1"===s.val())return s.val(e)}),s.parent().on("click",".add",function(){s.val()<parseInt(s.attr("max"))&&s.val(function(e,o){return++o})}),setTimeout(function(){$("#unit_output").focus().select()},0),$("#unit_output").keyup(function(){/\D/g.test(this.value)?this.value=this.value.replace(/\D/g,""):(this.value>e||this.value<1)&&(this.value=e)})}}var WORDFILTER=["kuk","kuken","hora","horunge","fitta","knulla","knullare","luder","bög","bögar","rövhål","cunt","fuck","fuck you","dick","cock","pussy","ashole"],MODS=["roYal","svabben","mlinde"],chatCom=io(location.host+"/chat_com",{reconnection:!0,reconnectionAttempts:1/0,transports:["websocket","polling"]});chatCom.on("message",function(e){var e=JSON.parse(e);$("#messages").append('<div class="'+e.type+'"><span class="name-'+e.color+'" >'+e.username+":</span> "+e.message+"</div>"),chatNotifier(),$("#messages").scrollTop($("#messages")[0].scrollHeight)}),$(function(){var e=Date.now();$("#send").click(function(){if(e<Date.now()){e=Date.now()+1e3;var o=$("#message").val().replace(/(<([^>]+)>)/gi,"");if(""!==o){var n={message:o,type:"userMessage"};chatCom.send(JSON.stringify(n)),$("#message").val("")}}return!1}),$("#message").on("keypress",function(e){13===e.keyCode&&$("#send").click()}),$(".slide-toggle").click(function(){$("#chatroom").animate({width:"toggle"}),$(".svg-container").toggleClass("big-map"),$(".slide-toggle").toggleClass("slide-toggle-close"),$(".slide-toggle").removeClass("chat-notifier-repeat"),resizeImage()}),$(window).width()<480&&($("#chatroom").css("display","none"),$("#chatroom").animate({width:"toggle"},{complete:function(){$(".slide-toggle").addClass("chat-notifier-repeat")}}),resizeImage())});var gameInfra=io(location.host+"/game_infra",{reconnection:!0,reconnectionAttempts:1/0,transports:["websocket","polling"]}),roomName=decodeURI((RegExp("room=(.+?)(&|$)").exec(location.search)||[,null])[1]);roomName&&(document.title=roomName,gameInfra.emit("player_ready",user),gameInfra.emit("join_room",roomName),gameInfra.emit("visitor",roomName)),gameInfra.on("disconnect",function(){disconnectedSound.play(),window.onbeforeunload=function(){};var e='<div class="modal-overlay"><div class="disconnect-popup"><span class="close-popup">X</span>';e+="<h1>Disconnected &#x2639;</h1><p>You drop connection and cannot see any activity anymore! Reload this window or reopen it to rejoin the game again.</p>",e+="</div></div>",$("body").append(e),$(".modal-overlay").css("display","block")}),gameInfra.on("not_activated",function(){var e='<div class="modal-overlay"><div class="disconnect-popup"><span class="close-popup">X</span>';e+="<h1>Activate your account &#x2639;</h1><p>Please check your email for activation link to be able to play.<br><a href='/sendVerificationToken'>Send new activation link</a></p></div></div>",$("body").append(e),$(".modal-overlay").css("display","block")});var mission,phase="Waiting for players",phaseMessage,activePlayer,playerEnabled,disconnectedSound=new Howl({src:["sounds/disconnected.mp3"]}),yourTurnSound=new Howl({src:["sounds/notify-turn.mp3"]}),gameOverSound=new Howl({src:["sounds/game-over.mp3"],volume:.5}),joinGameSound=new Howl({src:["sounds/player-joined.mp3"],volume:.5});gameInfra.on("message",function(e){switch(e.type){case"serverMessage":$("#messages").append('<div class="server-message">'+e.message+"</div>");break;case"phase":phase=e.message,phaseMessage=e.phaseMsg,0===$(".show-mission, .show-gold").length&&($(".phase-message").html('<div class="show-phase">Phase: '+phase+"</div>"),$(".phase-info").html(phaseMessage));var o=$("#phase_img");o.fadeOut(50,function(){o.attr("src","img/game/phases/"+phase+".png"),o.fadeIn(50)}),$(".remove_unit_bar").remove(),drawMap();break;case"attack":$(".show-phase").is(":visible")&&$(".phase-info").html(e.message);break;case"current_player":showActivePlayer(e);break;case"enable_player":playerEnabled=e.bool,"Game over"!==phase&&yourTurnSound.play();break;case"update_gold":$(".user-gold").html("<span>Gold: </span>"+e.gold);break;case"update_gold_income":$(".user-goldIncome").html("<span>Income: </span>"+e.goldIncome);break;case"start_game":clearInterval(countInterval),window.onbeforeunload=function(){return"Dude, are you sure you want to leave?"},yourTurnSound.play(),mission=e.mission;break;case"player_rejoin":window.onbeforeunload=function(){return"Dude, are you sure you want to leave?"},joinGameSound.play(),mission=e.mission;break;case"game_over":$("#messages").append('<div class="server-message">'+e.message+"</div>"),window.onbeforeunload=function(){},gameOverSound.play();break;case"disconnect":$("#messages").append('<div class="server-message">'+e.user+" left the room</div>"),gameInfra.emit("player_left",e.id);break;default:console.log("SWITCH ERROR")}}),gameInfra.on("start_countdown",function(){startTimer()}),gameInfra.on("error",function(e){console.log(Date()),console.log(phase),console.log(e)});var countInterval;gameInfra.on("game_countdown",function(e){if(e){$(".phase-message").html('<span style="color:#4bff00">Be ready!</span>'),$(".phase-info").html('<span style="color:#4bff00">The game starts in <b style="margin: 0px; color: #ff0" id="start_countdown">5</b> seconds.</span>');var o=4;countInterval=setInterval(function(){$("#start_countdown").html(o),0===o&&(clearInterval(countInterval),gameInfra.emit("countdown_finished",roomName)),o--},1e3)}else $(".phase-message").html("Oh no! player left the game"),$(".phase-info").html("The game will start as soon new players have joined.")}),gameInfra.on("clear_game_countdown",function(){clearInterval(countInterval)});var countdown;$("g").mouseenter(function(){playerEnabled?$(this).css("cursor","pointer"):$(this).css("cursor","default")}),$("g").mousedown(function(){if(playerEnabled){var e=getCountry(this.id),o=this.id;switch(phase){case"Everyone deploy":$.isNumeric(o)&&$.isNumeric(e.owner)&&gameInfra.emit("everyone_deploy",parseInt(o),e.owner);break;case"Deploy":$.isNumeric(o)&&$.isNumeric(e.owner)&&gameInfra.emit("deploy",parseInt(o),e.owner);break;case"Battle":battle(o,$(this));break;case"Tactical move":tacticalMove(o,$(this))}}}),gameInfra.on("list_of_players",function(e){$("#player_list").empty(),$.each(e,function(o,n){for(var t=n.points,a=0,i=0;i<e.length;i+=1)n.ip===e[i].ip&&(a+=1);if(a>1)r='<img src="img/ip-icon.png" alt="duplicate IP address" title="duplicate IP address"/>';else var r='<img src="img/users-icon.png" alt="normal user" title="normal user"/>';if(MODS.indexOf(n.username)>-1&&(r='<img src="img/moderator.png" alt="moderator" title="moderator"/>'),t<900)s="crown0.png";else if(t>=900&&t<1300)s="crown1.png";else if(t>=1300&&t<1500)s="crown2.png";else if(t>=1500&&t<1700)s="crown3.png";else if(t>=1700&&t<1900)s="crown4.png";else if(t>=1900&&t<2100)s="crown5.png";else if(t>=2100&&t<2300)s="crown6.png";else if(t>=2300&&t<2500)s="crown7.png";else if(t>=2500&&t<2700)s="crown8.png";else if(t>=2700&&t<2900)s="crown9.png";else var s="crown10.png";var l='<li class="player-name" style="color: '+n.color+' ">'+r+'<span class="player-username">'+n.username+'</span><span class="player-points">'+t+'<img src="img/rankings/'+s+'"/></span></li>';$("#player_list").append(l)})}),gameInfra.on("choose_color",function(e,o){$(".popup").remove();for(var n='<div class="modal-overlay"></div><div class="popup">  <span class="close-popup">X</span>  <div class="pophead">Please choose a color to play with</div>  <div class="popbody">    <ul>',t=0;t<o.length;t+=1)n+='<div class="player-check"> <input id="'+o[t]+'_player" type="checkbox"/> <label id="'+o[t]+'" for="'+o[t]+'_player"></label> </div>';n+="</ul></div></div>",$(".svg-container").before(n),$(".modal-overlay").css("display","block"),$.each(e,function(e,o){$("#"+o.color).remove()})}),gameInfra.on("remove_color_popup",function(e){$.each(e,function(e,o){$("#"+o.color).remove()}),joinGameSound.play()}),gameInfra.on("remove_color_popup_box",function(){$(".popup").remove(),$(".modal-overlay").css("display","none")}),gameInfra.on("withdraw_gold_effect",function(e){var o='<span class="user-gold-withdraw">-'+e+"</span>";$(".user-gold").append(o)}),gameInfra.on("display_flag",function(){$(".surrender-flag").css("display","block")});var resizeViewPort=function(e,o){window.outerWidth&&window.resizeTo(e+(window.outerWidth-window.innerWidth),o+(window.outerHeight-window.innerHeight))};resizeViewPort(835,523),$(function(){$("#next_turn").click(function(){gameInfra.emit("next_turn")}),$("#game_board").on("click","label",function(e){$(this).parent().is(".player-check")&&(gameInfra.emit("join_game",roomName,e.target.id),$(".popup").remove(),$(".modal-overlay").css("display","none"))}),$("#mission").click(function(){$("button.clicked-btn").removeClass("clicked-btn"),$(".show-mission").is(":visible")?($(".phase-message").html('<div class="show-phase">Phase: '+phase+"</div>"),$(".phase-info").html(phaseMessage)):($(".phase-message").html("<div class=show-mission>Game mission:</div>"),$(this).addClass("clicked-btn"),null!=mission?$(".phase-info").html(mission.message):$(".phase-info").html("Mission will be generated when the game begins."),drawMap())}),$(".dice-log").click(function(){window.open("/dicelog?room=log-"+roomName,"_blank","width=220,height=575")}),$(".surrender-flag").click(function(){confirm("Do you really want to surrender and lose this game?")&&(gameInfra.emit("surrender"),$(".surrender-flag").remove())}),$("body").on("click",".close-popup",function(){$(".disconnect-popup").remove(),$(".popup").remove(),$(".modal-overlay").css("display","none")})});var circles=[],disabledCountries=[];gameInfra.on("nuke_country",function(e){var o=document.getElementsByTagName("circle")[e];o.setAttribute("filter","url(#explosion)"),o.setAttribute("r",45),setTimeout(function(){o.setAttribute("r",20),o.removeAttribute("filter","url(#explosion)")},600)}),gameInfra.on("attacker_animation",function(e){var o=document.getElementsByTagName("circle")[e];o.setAttribute("filter","url(#cannon)"),o.setAttribute("r",30),setTimeout(function(){o.setAttribute("r",20),o.removeAttribute("filter","url(#cannon)")},600)}),gameInfra.on("bounce_country",function(e){var o=document.getElementsByTagName("circle")[e];o.classList.toggle("bounce"),o.setAttribute("r",25),setTimeout(function(){o.classList.toggle("bounce"),o.setAttribute("r",20)},300)}),gameInfra.on("render_map",function(e){circles=[];for(var o in e)if(e.hasOwnProperty(o))for(var n=0,t=e[o].countries.length;n<t;n++)circles.push({country:e[o].countries[n],color:e[o].color,owner:e[o].id});drawMap()}),gameInfra.on("render_no_army_map",function(e){circles=[];for(var o in e)if(e.hasOwnProperty(o))for(var n=0,t=e[o].countries.length;n<t;n++)e[o].countries[n].units=1,circles.push({country:e[o].countries[n],color:e[o].color,owner:e[o].id})}),gameInfra.on("render_map_everyone_deploy",function(e,o){circles=[];for(var n in e)if(e.hasOwnProperty(n))for(var t=0,a=e[n].countries.length;t<a;t++)e[n].countries[t].units=1,circles.push({country:e[n].countries[t],color:e[n].color,owner:e[n].id});for(var n in o)if(o.hasOwnProperty(n))for(var t=0,a=o[n].countries.length;t<a;t++)circles.push({country:o[n].countries[t],color:o[n].color,owner:o[n].id});drawMap()}),gameInfra.on("render_disabled_countries",function(e){disabledCountries=[];for(var o=0;o<e.length;o++)disabledCountries.push({id:e[o].id,units:e[o].units})}),$(function(){$("#show_gold").click(function(){$("button.clicked-btn").removeClass("clicked-btn"),$(".show-gold").is(":visible")?($(".phase-message").html('<div class="show-phase">Phase: '+phase+"</div>"),$(".phase-info").html(phaseMessage),drawMap()):(drawGold(),$(this).addClass("clicked-btn"),$(".phase-info").empty(),$(".phase-message").html("<div class=show-gold><p>Europe: 10 gold </p><p>East europe: 10 gold </p><p>Asia: 8 gold </p><p>Middle east: 4 gold </p><p>Africa: 6 gold </p></div>"))})});var countriesGold=[{id:0,gold:2},{id:1,gold:2},{id:2,gold:2},{id:3,gold:2},{id:4,gold:2},{id:5,gold:1},{id:6,gold:2},{id:7,gold:5},{id:8,gold:2},{id:9,gold:1},{id:10,gold:2},{id:11,gold:2},{id:12,gold:2},{id:13,gold:2},{id:14,gold:2},{id:15,gold:5},{id:16,gold:2},{id:17,gold:2},{id:18,gold:2},{id:19,gold:2},{id:20,gold:5},{id:21,gold:2},{id:22,gold:2},{id:23,gold:2},{id:24,gold:5},{id:25,gold:2},{id:26,gold:2},{id:27,gold:2},{id:28,gold:2},{id:29,gold:2},{id:30,gold:5},{id:31,gold:2},{id:32,gold:1}];drawGold();var isMobile=!!/Android|webOS|iPhone|iPad|iPod|Windows Phone|BlackBerry/i.test(navigator.userAgent);$(window).resize(function(){resizeImage()});var el=$(".svg-container"),cont=$(".svg-content");resizeImage();var attackFrom,countryFrom;$(".svg-container").on("mousedown","#cancel_units",function(){$(".remove_unit_bar").remove(),drawMap()});
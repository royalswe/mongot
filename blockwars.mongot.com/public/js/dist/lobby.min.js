"use strict";var UTILS={getCrownImg:function(e){return null===e?"guest.png":e<900?"crown0.png":900<=e&&e<1300?"crown1.png":1300<=e&&e<1500?"crown2.png":1500<=e&&e<1700?"crown3.png":1700<=e&&e<1900?"crown4.png":1900<=e&&e<2100?"crown5.png":2100<=e&&e<2300?"crown6.png":2300<=e&&e<2500?"crown7.png":2500<=e&&e<2700?"crown8.png":2700<=e&&e<2900?"crown9.png":"crown10.png"},MODS:["roYal","svabben","mlinde"],WORDFILTER:["kuk","kuken","hora","horunge","fitta","knulla","knullare","luder","bög","bögar","rövhål","cunt","fuck","fuck you","dick","cock","pussy","ashole"]},NOTIFICATION=function(){var n="guest"===user?"guest":user.username,t=Date.now();function e(){navigator.serviceWorker.register("/js/service-worker.js").then(function(e){e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:function(e){for(var n="=".repeat((4-e.length%4)%4),t=(e+n).replace(/\-/g,"+").replace(/_/g,"/"),o=window.atob(t),s=new Uint8Array(o.length),r=0;r<o.length;++r)s[r]=o.charCodeAt(r);return s}("BEjK-T4xq910AGfKQ09xIF_hCgBUTebFj2ZPaHilzouo8ca3kjJAmX4WjgQp8n8Yg02Bu5hwp97MLu0a14OP4RY")}).then(function(e){fetch("/subscribe",{method:"POST",body:JSON.stringify({subscription:e,username:n}),headers:{"content-type":"application/json"}})})})}function o(){return"granted"===Notification.permission?localStorage.getItem("notification-permissions"):Notification.permission}fetch("/send-pw",{method:"POST",body:JSON.stringify({username:n}),headers:{"content-type":"application/json"}}),"Notification"in window&&"granted"===o()&&(document.getElementById("toggle_notification").checked=!0);var s=new Howl({src:["sounds/join-lobby.mp3"]});return{togglePushNotification:function(){"serviceWorker"in navigator?e():alert("Sorry but your browser does not support push notification")},toggleNotificationPermissions:function(e){var n=e.checked;if(!("Notification"in window))return alert("Sorry but your browser does not support desktop notification");"granted"===Notification.permission?localStorage.setItem("notification-permissions",n?"granted":"denied"):"denied"===Notification.permission?(localStorage.setItem("notification-permissions","denied"),n=!1):"default"===Notification.permission&&Notification.requestPermission(function(e){"granted"===e?localStorage.setItem("notification-permissions",n?"granted":"denied"):(localStorage.setItem("notification-permissions","denied"),n=!1)})},userNotification:function(e){console.log(Notification.permission),"granted"===o()&&t<Date.now()&&(t=Date.now()+6e4,function(e,n){var t=new Notification(n,{icon:e});s.play(),setTimeout(t.close.bind(t),3e3)}("img/pacghost-meta.png",e.msg))}}}(),Lobby=function(){var t=this,a=new WebSocket(("https:"===window.location.protocol?"wss://":"ws://")+location.host+"/lobby");(this.ws=a).addEventListener("open",function(){var e=JSON.stringify({type:"init_lobby",user:user});a.send(e)}),window.addEventListener("beforeunload",function(){a.close()}),a.onclose=function(){setTimeout(function(){var e=document.createElement("div");e.innerText="Connectiond lost. Reload page to reconnect!",e.className="dropped-connection";var n=document.getElementsByTagName("header")[0];n.parentNode.insertBefore(e,n.nextSibling)},2e3)},a.addEventListener("message",function(e){var n=JSON.parse(e.data);switch(n.type){case"userMessage":t.renderMessages([n.message]);break;case"render_messages":t.renderMessages(n.messages);break;case"render_rooms":t.renderRooms(n);break;case"users_online":t.renderConnectedUsers(n.users);break;case"user_notification":NOTIFICATION.userNotification(n)}});var i=Date.now();document.getElementById("send").onclick=function(){var e=document.getElementById("message").value;if(400<e.length)return document.getElementById("messages").innerHTML+='<div class="new-message"><span class="chat-message">Your text is too long</span></div>';String.prototype.repeat=function(e){return new Array(e+1).join(this)};for(var n=0;n<UTILS.WORDFILTER.length;n+=1){var t=new RegExp("\\b"+UTILS.WORDFILTER[n]+"\\b","i"),o="*".repeat(UTILS.WORDFILTER[n].length);e=e.replace(t,o)}var s=e.replace(/(<([^>]+)>)/gi,"");if(""!==s)if(i<Date.now()){i=Date.now()+2e3;var r={message:s,type:"userMessage",user:"guest"===user?"guest":user.username};a.send(JSON.stringify(r)),document.getElementById("message").value=""}else document.getElementById("messages").innerHTML+='<div class="new-message"><span class="chat-message">You are writing to fast</span></div>';return!1},document.getElementById("message").addEventListener("keypress",function(e){13===e.keyCode&&document.getElementById("send").click()})};Lobby.prototype.renderRooms=function(e){var n=e.rooms;n.sort(function(e,n){var t=e.ranking,o=n.ranking;return t<o?-1:o<t?1:0});var i="";n.forEach(function(e){var n="open";"waiting"===e.status&&0<e.activePlayers.length?n="waiting for players":"running"===e.status&&(n="game in progress");var t="join-btn",o="<td>";if(0<e.players.length){o="<td class='tooltip'>";for(var s="<ul class='tooltiptext'>",r=0;r<e.players.length;r++){var a=e.players[r];a.name===user.username&&(t+=" disable-join-link"),a.points?s+="<li> <img src='img/rankings/".concat(UTILS.getCrownImg(a.points),"'/> ").concat(a.name,"</li>"):s+="<li> <img src='img/rankings/guest.png'/> ".concat(a.name,"</li>")}o+=s+"</ul>"}i+="<tr><td>\n        ".concat(e.name,"\n        </td>\n        ").concat(o).concat(e.activePlayers.length,"/").concat(e.players.length,"\n        </td><td>\n        ").concat(n,"\n        </td><td title='Ranked games are only for registered players'>\n        ").concat(e.ranking,'\n        </td><td>\n        <button data-room="').concat(e.name,'" onclick="window.open(\'/game?room=').concat(e.name,"', '_blank', 'width=1000,height=740')\" class=\"").concat(t,'">Join Room</button>\n        </td></tr>')}),document.getElementsByTagName("tbody")[0].innerHTML=i},Lobby.prototype.renderConnectedUsers=function(e){var n=document.getElementById("users_online");n.innerHTML='<p id="user_online_list">Users in lobby ('+e.length+")</p>",document.title="Lobby ("+e.length+")";for(var t=0;t<e.length;t++){var o=e[t].points,s="rankings/",r=o+" points";-1<UTILS.MODS.indexOf(e[t].username)?(r="moderator: "+o+" points",s+="moderator.png"):null===o?(r="guest",s+="guest.png"):s+=UTILS.getCrownImg(o),n.innerHTML+=null===o?'<p><img src="img/'.concat(s,'" title="').concat(r,'" alt="').concat(r,'"/>').concat(e[t].username,"</p>"):'<a href="https://miniblip.com/user/'.concat(e[t].username,'"><img src="img/').concat(s,'" title="').concat(r,'" alt="').concat(r,'"/>').concat(e[t].username,"</a>")}},Lobby.prototype.renderMessages=function(e){var n=document.getElementById("messages");1<e.length&&(n.innerHTML="");for(var t=0;t<e.length;t++){var o=new Date(e[t].timeStamp),s=o.getDate()+"/"+(o.getMonth()+1)+" "+("0"+o.getHours()).slice(-2)+":"+("0"+o.getMinutes()).slice(-2),r='<div class="new-message '+e[t].type+'"><span class="chat-timeStamp">'+s+'</span> <span class="name">'+e[t].username+':</span> <span class="chat-message">'+e[t].message+"</span> ";user.god&&1<e.length&&(r+='<span class="remove-message" onclick="removeMessage(\''+t+"')\">Remove</span>"),r+="</div>",n.innerHTML+=r}n.scrollTop=n.scrollHeight};var lobby=new Lobby;function removeMessage(e){confirm("Do you want to remove this message?")&&lobby.ws.send(JSON.stringify({type:"remove_message",index:e,god:user.god}))}
"use strict";var UTILS={getCrownImg:function(e){return null===e?"guest.png":e<900?"crown0.png":900<=e&&e<1300?"crown1.png":1300<=e&&e<1500?"crown2.png":1500<=e&&e<1700?"crown3.png":1700<=e&&e<1900?"crown4.png":1900<=e&&e<2100?"crown5.png":2100<=e&&e<2300?"crown6.png":2300<=e&&e<2500?"crown7.png":2500<=e&&e<2700?"crown8.png":2700<=e&&e<2900?"crown9.png":"crown10.png"},MODS:["roYal","svabben","mlinde"],WORDFILTER:["kuk","kuken","hora","horunge","fitta","knulla","knullare","luder","bög","bögar","rövhål","cunt","fuck","fuck you","dick","cock","pussy","ashole"]},TETRIS={specialName:function(e){switch(e){case 8:return"Add row";case 9:return"Remove row";case 10:return"Earthquake";case 11:return"Milkshake";case 12:return"Specials away";case 13:return"Shotgun";case 14:return"Gravity";case 15:return"Clear arena";case 16:return"Switch Arena";case 17:return"Monster";case 18:return"Mini bomb";default:return""}},TilesHeight:22,TilesWidth:10,playerReadyClass:"player-ready-status",statusReady:"ready",statusWaiting:"waiting"},SCREEN=function(){function n(){return document.fullScreenElement&&null!==document.fullScreenElement||document.mozFullScreen||document.webkitIsFullScreen}return window.onresize=function(){setTimeout(SCREEN.resizeContent,1e3),SCREEN.resizeContent()},{resizeViewPort:function(e,t){window.outerWidth&&window.resizeTo(e+(window.outerWidth-window.innerWidth),t+(window.outerHeight-window.innerHeight))},toggleFullscreen:function(){var e=document.documentElement;if(n())if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{if(!document.msExitFullscreen)return alert("Your browser do not support fullscreen");document.msExitFullscreen()}else if(e.requestFullscreen)e.requestFullscreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else{if(!e.msRequestFullscreen)return alert("Your browser do not support fullscreen");e.msRequestFullscreen()}},resizeContent:function(){document.getElementById("toggle_fullscreen").checked=!n();var e=window.innerHeight,t=window.innerWidth,i=e/3+e;if(e<t)document.documentElement.style.width=t<i?"100%":i+"px";else if(e-t<60){var a=.8*e;document.documentElement.style.width=a+"px"}else document.documentElement.style.width="100%"}}}();function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var i=[],a=!0,n=!1,r=void 0;try{for(var s,o=e[Symbol.iterator]();!(a=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);a=!0);}catch(e){n=!0,r=e}finally{try{a||null==o.return||o.return()}finally{if(n)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}var ConnectionManager=function(e){this.conn=null,this.peers=new Map,this.readyBtn=!1,this.joinBtn=!1,this.chat=new Chat(e,this),this.tetrisManager=new TetrisManager(e),this.localTetris=null,this.localID=null,this.countDownInterval=null,this.CountDownSound=new Howl({src:["sounds/get-ready.mp3"],volume:.4}),this.GameWon=new Howl({src:["sounds/winner.mp3"]}),this.GameLost=new Howl({src:["sounds/lost.mp3"]})};function removeElementsByClass(e){for(var t=document.getElementsByClassName(e);0<t.length;)t[0].parentNode.removeChild(t[0])}function removeElementById(e){document.getElementById(e)&&document.getElementById(e).remove()}function writeToLog(e){document.getElementById("game_log").appendChild(e);var t=document.getElementsByClassName("game-description")[0];t.scrollTop=t.scrollHeight}ConnectionManager.prototype.connect=function(e){var t=this;this.tetrisManager.initArenas(),this.conn=new WebSocket(e),this.conn.addEventListener("open",function(){t.initSession()}),this.conn.addEventListener("message",function(e){t.receive(e)}),this.conn.onclose=function(){null!==t.localTetris&&t.localTetris.stop(),t.conn=null;document.getElementsByTagName("body")[0].innerHTML+='<div class="modal-overlay"><div class="disconnect-popup"><span class="close-popup">X</span><h1>Disconnected &#x2639;</h1><p>You dropped connection! Refresh the page to establish the game again.</p><button id="reload_page">Reload page</button></div></div>',document.getElementById("reload_page").addEventListener("click",function(){location.reload()},!1),document.getElementsByClassName("close-popup")[0].addEventListener("click",function(){removeElementsByClass("modal-overlay")},!1)},window.addEventListener("beforeunload",function(){t.conn.close()})},ConnectionManager.prototype.initSession=function(){this.showAvailableSeats();var e=decodeURI((RegExp("room=(.+?)(&|$)").exec(location.search)||["",null])[1]),t=decodeURI((RegExp("rank=(.+?)(&|$)").exec(location.search)||["",null])[1]);(document.title=e)&&this.send({type:"join-session",user:user,name:e,ranking:t.toLowerCase()})},ConnectionManager.prototype.join=function(){this.toggleBtnType("hide-join"),this.localTetris=this.tetrisManager.createLocalPlayer(),this.showAvailableSeats();var e=this.localTetris.serialize();this.watchEvents(),this.send({type:"join-game",state:e})},ConnectionManager.prototype.send=function(e){this.conn.send(JSON.stringify(e))},ConnectionManager.prototype.showAvailableSeats=function(){for(var e=document.getElementsByClassName("arena"),t=0;t<e.length;t+=1)if(!e[t].querySelector(".client-number")&&!e[t].querySelector(".open-seat")){var i=document.createElement("span");i.innerHTML="Seat open",i.className="open-seat",e[t].appendChild(i)}for(var a=document.getElementsByClassName("empty-arena");a[0];)a[0].classList.remove("empty-arena")},ConnectionManager.prototype.countDown=function(){var e=this;"off"!==localStorage.getItem("toggle-sound")&&this.CountDownSound.play(),clearInterval(this.countDownInterval),removeElementById("count_down");for(var t=document.getElementsByClassName("client-number"),i=0;i<t.length;i++)t[i].style.top="97%";var a=document.getElementsByClassName("arena")[2],n=document.createElement("span");n.innerHTML="&nbsp;",a.appendChild(n),n.id="count_down";var r=10;this.countDownInterval=setInterval(function(){0===(n.innerHTML=r)&&(clearInterval(e.countDownInterval),n.remove(),removeElementsByClass(TETRIS.playerReadyClass)),r--},1e3)},ConnectionManager.prototype.updateManager=function(n){var r=this;n.clients.forEach(function(e){if(n.you!==e.id&&!r.peers.has(e.id)){var t=r.tetrisManager.createPlayer();t.unserialize(e.state),r.peers.set(e.id,t),t.arenaNaming(e),e.lost&&t.gameOver("GAME OVER")}}),_toConsumableArray(this.peers.entries()).forEach(function(e){var t=_slicedToArray(e,2),i=t[0],a=t[1];n.clients.some(function(e){return e.id===i})||(r.tetrisManager.removePlayer(a,n.gamestatus),r.peers.delete(i))}),4<this.peers.size?this.toggleBtnType("hide-join"):null===this.localTetris?this.toggleBtnType("join"):"running"===n.gamestatus&&this.toggleBtnType("hide")},ConnectionManager.prototype.updatePeer=function(e,t,i){var a=_slicedToArray(i,2),n=a[0],r=a[1];if(!this.peers.has(e))return console.error("client does not exist",e);var s=this.peers.get(e);s[t][n]=r,s.draw()},ConnectionManager.prototype.start=function(e){clearInterval(this.countDownInterval),removeElementById("count_down");for(var t=document.getElementsByClassName("client-number"),i=0;i<t.length;i++)t[i].style.top="97%";var a=document.createElement("li");a.innerHTML="The game has started!",writeToLog(a),removeElementsByClass(TETRIS.playerReadyClass);for(var n=document.getElementsByClassName("open-seat"),r=0;r<n.length;r+=1)n[r].parentNode.querySelector(".tetris").classList.add("empty-arena");for(;n[0];)n[0].parentNode.removeChild(n[0]);this.joinBtn&&(this.joinBtn.style.background="#dc862a99"),null!=this.localTetris&&(this.localTetris.arena.clear(),this.localTetris.special.clearSpecials(),this.localTetris.block.blocks=e.blocks,this.localTetris.block.initializeBlocks=e.blocks,this.localTetris.run(),this.localTetris.block.randomizeBlock(),this.localTetris.block.blockControll(),this.localTetris.special.sendingSpecial=!1)},ConnectionManager.prototype.logSpecial=function(e){var t=document.createElement("li"),i=document.createElement("img");i.src="img/game/specials/"+e.special+".gif",19===e.special?(t.appendChild(i),t.innerHTML+=e.clientId+" collected a mine",t.style.color="red"):(t.innerHTML=e.clientId+" >",t.appendChild(i),t.innerHTML+=TETRIS.specialName(e.special)+" > "+e.receiver),writeToLog(t),this.peers.get(e.receiver)&&this.peers.get(e.receiver).bounceArena()},ConnectionManager.prototype.receive=function(e){var n=this,t=JSON.parse(e.data);switch(t.type){case"session-broadcast":this.updateManager(t.peers);break;case"state-update":this.updatePeer(t.clientId,t.fragment,t.state);break;case"add-special":this.localTetris.special.updateSpecials(t);break;case"use-special":var i;if(16===t.special){if(!this.peers.has(t.clientId))return;i=this.peers.get(t.clientId).arena.matrix}this.localTetris.special.performSpecial(t,i);break;case"log-special":this.logSpecial(t);break;case"remove-special":this.localTetris.special.removeSpecial();break;case"use-special-failed":this.localTetris.special.sendingSpecial=!1;break;case"join-session":this.localID=t.clientId,t.isGuest?(t.msg="&#8505; <a style='color: #0088ff' href='https://miniblip.com/register'>Register</a> new account or  <a style='color: #0088ff' href='https://miniblip.com/login'>login</a> to play in ranked rooms.",this.chat.serverMessage(t)):(this.readyBtn=document.getElementById("player_ready"),this.joinBtn=document.getElementById("join_game"),this.joinBtn.addEventListener("click",function(){n.join()},!1),this.readyBtn.addEventListener("click",function(){n.send({type:"player-ready"})},!1)),t.joinable&&this.toggleBtnType("join"),"running"===t.status&&this.start(t);break;case"player-ready":this.peers.has(t.clientId)&&this.peers.get(t.clientId).playerReady(),t.clientId===this.localID&&this.toggleBtnType("hide");break;case"join-game":this.toggleBtnType("ready"),this.localTetris.arenaNaming(t),this.peers.set(t.id,this.localTetris);break;case"unjoin-arena":"ready"===t.status&&this.toggleBtnType("ready"),"joined"===t.status&&(this.toggleBtnType("join"),this.localTetris=null),removeElementsByClass(TETRIS.playerReadyClass);for(var a=document.getElementsByClassName("client-number"),r=0;r<a.length;r++)a[r].style.top="39%";this.showAvailableSeats();break;case"start-countdown":this.countDown();break;case"state-lost":this.peers.has(t.clientId)&&(this.peers.get(t.clientId).gameOver("GAME OVER"),this.peers.get(t.clientId).stop()),t.clientId===this.localID&&"off"!==localStorage.getItem("toggle-sound")&&this.GameLost.play();break;case"game-start":this.start(t);break;case"speed-up-blocks":this.localTetris&&this.localTetris.speedUpBlocks();var s=document.createElement("li");s.className="player-info",s.innerHTML="&#187; Game speed increased",writeToLog(s);break;case"state-winner":"no-winner"===t.winner?t.winner="no one ":this.peers.has(t.winner)&&(this.peers.get(t.winner).gameOver("WINNER"),this.peers.get(t.winner).stop()),t.winner===this.localID&&"off"!==localStorage.getItem("toggle-sound")&&this.GameWon.play();var o=document.createElement("li");o.innerHTML=t.winner+" won the game!",o.className="player-info",writeToLog(o);var l=document.getElementsByClassName("game-description")[0];l.scrollTop=l.scrollHeight,t.gameTime&&(t.msg='<span style="color:#ffffff">&#128337; </span> Game time: '+t.gameTime,this.chat.serverMessage(t)),this.joinBtn&&this.joinBtn.style.removeProperty("background"),this.countDownInterval=setTimeout(function(){for(var e=document.getElementsByClassName("gameover"),t=0;t<e.length;t++)e[t].classList.add("hideGameOver");for(var i=document.getElementsByClassName("client-number"),a=0;a<i.length;a++)i[a].style.top="39%";n.localTetris?n.toggleBtnType("ready"):n.peers.size<5&&n.toggleBtnType("join"),n.showAvailableSeats()},2e3),setTimeout(removeElementsByClass,3500,"gameover");break;case"state-chat":this.chat.message(t);break;case"server-message":this.chat.serverMessage(t);break;case"status-error":console.log("status-error",t.message);break;case"update-scores":for(var c=t.players,h=0;h<c.length;h++){var m=document.getElementById(c[h].name+"_crown");m&&(m.src="img/rankings/"+UTILS.getCrownImg(c[h].newPoints),m.title=c[h].newPoints),c[h].pointsLost?c.msg='<span style="color:#ffffff">&#9760;</span> '+c[h].name+" lost "+c[h].pointsLost+" points.":c.msg='<span style="color:#ffd700">&#9813;</span> '+c[h].name+" won "+c[h].pointsWon+" points.",this.chat.serverMessage(c)}break;default:console.log("No switch case")}},ConnectionManager.prototype.watchEvents=function(){var i=this,e=this.localTetris,a=e.block;["pos","matrix"].forEach(function(t){a.events.listen(t,function(e){i.send({fragment:"block",state:[t,e],type:"state-update"})})}),a.events.listen("lost",function(e){i.localTetris.stop(),i.send({state:["lost",e],type:"state-lost"})});var t=e.arena;t.events.listen("special",function(e,t){i.send({type:e,specials:t})}),t.events.listen("matrix",function(e){i.send({type:"state-update",fragment:"arena",state:["matrix",e]})})},ConnectionManager.prototype.toggleBtnType=function(e){this.joinBtn&&("join"===e?(this.joinBtn.style.display="block",this.readyBtn.style.display="none"):"ready"===e?(this.joinBtn.style.display="none",this.readyBtn.style.display="block"):"hide"===e?(this.joinBtn.style.display="none",this.readyBtn.style.display="none"):"hide-join"===e&&(this.joinBtn.style.display="none"))};var TetrisManager=function(e){this.document=e,this.template=e.querySelector("#player_template"),this.loacalTemplate=e.querySelector("#local_template")};TetrisManager.prototype.initArenas=function(){for(var e=0;e<5;e++){var t=document.importNode(this.template.content,!0).children[0];this.document.getElementById("arena_container").appendChild(t)}},TetrisManager.prototype.createLocalPlayer=function(){if(this.document.querySelector(".arena.local")){var e=document.createElement("li");e.innerHTML="you allready have an local instance!",document.getElementById("game_log").appendChild(e),this.document.querySelector(".arena.local").remove()}else this.document.querySelector(".arena.open").remove();var t=this.document.importNode(this.loacalTemplate.content,!0).children[0],i=new Tetris(t),a=this.document.getElementsByClassName("arena")[2];return a.parentNode.insertBefore(i.element,a),i},TetrisManager.prototype.createPlayer=function(){var e=this.document.importNode(this.template.content,!0).children[0],t=new Tetris(e);t.element.className="arena closed";var i=this.document.getElementsByClassName("arena open")[0];i.parentNode.insertBefore(t.element,i),i.remove();var a=this.document.getElementsByClassName("arena local")[0],n=this.document.getElementsByClassName("arena")[2];return a&&a!==n&&(console.log("The arena moved"),n.parentNode.insertBefore(a,n)),t},TetrisManager.prototype.removePlayer=function(e,t){var i=document.importNode(this.template.content,!0).children[0];if(e.element.parentNode.insertBefore(i,e.element),e.element.remove(),"running"===t){i.querySelector(".tetris").classList.add("empty-arena");var a=document.createElement("span");a.className="gameover loser",a.innerHTML="GAME OVER",i.appendChild(a)}else{var n=document.createElement("span");n.innerHTML="Seat open",n.className="open-seat",i.appendChild(n)}};var Tetris=function(e){var i=this;this.element=e,this.canvas=e.querySelector("canvas.tetris"),this.ctx=this.canvas.getContext("2d"),this.ctx.translate(0,-19),this.ctx.scale(24,22),this.nextCanvas=null,this.nextCtx=null,this.arena=new Arena(this,TETRIS.TilesWidth,TETRIS.TilesHeight),this.block=new Block(this),this.special=new Special(this),this.borders=[null,"#FF0D72","#0DC2FF","#0DFF72","#F538FF","#FF8E0D","#FFE138","#3877FF","#00ff17"],this.colors=[null,"#b3004a","#0099cc","#00cc55","#da00e6","#cc6d00","#e6c300","#0051ff","#00b30f"],this.gameAnimation=null,this.stopped=!1,this.images=Array.from({length:12},function(e,t){var i=new Image;return i.src="img/game/specials/"+(t+8)+".gif",i}),this.handleVisibilityChange=function(){document.hidden&&!i.stopped&&setTimeout(function(){i.block.drop(),i.draw(),i.handleVisibilityChange()},620)};var a=0;this._update=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=e-a;a=e,i.block.update(t),i.draw(),!1===i.stopped&&(i.gameAnimation=requestAnimationFrame(i._update))}};Tetris.prototype.drawSweepRow=function(s,o){var l=this;this.stopped=null;var c,h,m=Date.now(),p=90;!function e(){if(!(10<p)){for(var t=0;t<s.length;t++){var i=l.arena.matrix.splice(s[t]+t,1)[0].fill(0);l.arena.matrix.unshift(i)}return null===l.stopped&&(l.stopped=!1,l._update()),o()}if(requestAnimationFrame(e),c=Date.now(),500/30<(h=c-m)){m=c-h%(500/30),p-=5;for(var a=0;a<s.length;a++)for(var n=s[a],r=0;r<TETRIS.TilesWidth;r++)l.ctx.fillStyle="#333333",l.ctx.fillRect(r,n,1,1),l.ctx.fillStyle="rgba(255, 255, 255, 0."+p+"10)",l.ctx.fillRect(r,n,1,1),l.ctx.fillStyle="rgba(255, 255, 255, 0."+p+")",l.ctx.fillRect(r,n,.8,.8),l.ctx.fillStyle="rgba(255, 255, 255, 0."+p+")",l.ctx.fillRect(r+.1,n+.1,.1,.3),l.ctx.fillRect(r+.1,n+.1,.3,.1)}}()},Tetris.prototype.draw=function(){this.ctx.fillStyle="#333333",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawMatrix(this.arena.matrix,{x:0,y:0}),this.drawMatrix(this.block.matrix,this.block.pos)},Tetris.prototype.drawMatrix=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],a=this.ctx;i&&((a=this.nextCtx).fillStyle="#333333",a.fillRect(0,0,this.nextCanvas.width,this.nextCanvas.height));for(var n=0;n<e.length;n+=1)for(var r=0;r<e[n].length;r+=1)7<e[n][r]?a.drawImage(this.images[e[n][r]-8],r,n,.99,.99):0!==e[n][r]&&(a.beginPath(),a.fillStyle=this.colors[e[n][r]],a.fillRect(r+t.x,n+t.y,1,1),a.fillStyle=this.borders[e[n][r]],a.fillRect(r+t.x,n+t.y,.8,.8),a.fillStyle="#fff",a.fillRect(r+t.x+.1,n+t.y+.1,.1,.3),a.fillRect(r+t.x+.1,n+t.y+.1,.3,.1),a.stroke())},Tetris.prototype.run=function(){this.nextCanvas||(this.nextCanvas=document.querySelector("canvas.next-block"),this.nextCtx=this.nextCanvas.getContext("2d"),this.nextCtx.scale(40,34)),this.block.DROP_SLOW=800,this.block.dropInterval=this.block.DROP_SLOW,this.stopped=!1,this._update(),this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.handleVisibilityChange,!1)},Tetris.prototype.serialize=function(){return{arena:{matrix:this.arena.matrix},block:{matrix:this.block.matrix,pos:this.block.pos}}},Tetris.prototype.unserialize=function(e){this.arena=Object.assign(e.arena),this.block=Object.assign(e.block),this.draw()},Tetris.prototype.arenaNaming=function(e){this.element.querySelector(".open-seat")&&this.element.querySelector(".open-seat").remove(),"ready"===e.status&&"waiting"===e.gamestatus&&this.playerReady();var t=e.points,i='<img src="img/rankings/'+UTILS.getCrownImg(t)+'" id="'+e.id+'_crown" title="'+t+' points" alt="'+t+' points"/>',a=this.element.querySelector(".client-name");a.className+=" client-number",a.style.top="39%",a.dataset.player=e.id,a.innerHTML=i+"<span>"+e.id+"</span>"},Tetris.prototype.playerReady=function(){var e=document.createElement("span");e.className=TETRIS.playerReadyClass,e.innerHTML="ready",this.element.appendChild(e)},Tetris.prototype.gameOver=function(e){var t=document.createElement("span"),i="WINNER"===e?"winner":"loser";t.className="gameover "+i,t.innerHTML=e,this.element.appendChild(t)},Tetris.prototype.stop=function(){this.stopped=!0,cancelAnimationFrame(this.gameAnimation)},Tetris.prototype.bounceArena=function(){this.element.querySelector(".tetris").classList.remove("tetris-pulse"),this.element.offsetWidth,this.element.querySelector(".tetris").classList.add("tetris-pulse")},Tetris.prototype.speedUpBlocks=function(){this.block.DROP_SLOW=this.block.DROP_SLOW/2,this.block.dropInterval=this.block.DROP_SLOW;var e=document.createElement("div");e.className="display-speed-up",e.innerHTML="Speed up!",this.element.appendChild(e),setTimeout(function(){e.remove()},1100)};var Events=function(){this._listeners=new Set};Events.prototype.listen=function(e,t){this._listeners.add({name:e,callback:t})},Events.prototype.emit=function(t){for(var e=arguments.length,i=new Array(1<e?e-1:0),a=1;a<e;a++)i[a-1]=arguments[a];this._listeners.forEach(function(e){e.name===t&&e.callback.apply(e,i)})};var Arena=function(e,t,i){for(var a=[];i--;)a.push(new Array(t).fill(0));this.matrix=a,this.tetris=e,this.events=new Events};Arena.prototype.clear=function(){for(var e=0;e<this.matrix.length;e+=1)this.matrix[e].fill(0);this.events.emit("matrix",this.matrix)},Arena.prototype.sweepRow=function(e){var t=this,i=[],a=0,n=[];e:for(var r=this.matrix.length-1;0<r;r-=1){i=[];for(var s=0;s<this.matrix[r].length;s+=1){if(0===this.matrix[r][s])continue e;7<this.matrix[r][s]&&i.push(this.matrix[r][s])}if(0<i.length&&(this.events.emit("special","add-special",i),-1!==i.indexOf(19)))return;n.push(r),a++}if(!(0<n.length))return e();this.tetris.drawSweepRow(n,function(){for(;1<a;a-=2)t.createSpecial();return t.events.emit("matrix",t.matrix),t.tetris.block.dropInterval=t.tetris.block.DROP_SLOW,e()})},Arena.prototype.createSpecial=function(){var e=0;e:for(var t=0;t<this.matrix.length;t+=1){for(var i=0;i<this.matrix[t].length;i+=1)if(this.matrix[t][i])break e;e++}if(console.log(e,TETRIS.TilesHeight),!(e>=TETRIS.TilesHeight)){for(var a,n,r=function(e){var t,i=0,a=Math.random();for(t in e)if(a<=(i+=e[t]))return t}({8:.28,9:.28,10:.07,11:.04,12:.06,13:.09,14:.05,15:.04,16:.04,17:.01,18:.04}),s=500;s--;)if(a=Math.floor(Math.random()*TETRIS.TilesWidth+0),n=Math.floor(Math.random()*(21-e+1))+e,0<this.matrix[n][a]&&this.matrix[n][a]<8)return this.matrix[n][a]=parseInt(r);console.log("wow over 500 randoms")}},Arena.prototype.collide=function(e){for(var t=e.matrix,i=e.pos,a=0;a<t.length;a+=1)for(var n=0;n<t[a].length;n+=1)if(0!==t[a][n]&&0!==(this.matrix[a+i.y]&&this.matrix[a+i.y][n+i.x]))return!0;return!1},Arena.prototype.merge=function(e){for(var t=0;t<e.matrix.length;t+=1)for(var i=0;i<e.matrix[t].length;i+=1)0!==e.matrix[t][i]&&(this.matrix[t+e.pos.y][i+e.pos.x]=e.matrix[t][i]);this.events.emit("matrix",this.matrix)};var Block=function(e){this.DROP_SLOW=800,this.DROP_FAST=50,this.MOVE_SIDEWAYS=5,this.events=new Events,this.tetris=e,this.arena=e.arena,this.dropCounter=0,this.dropInterval=this.DROP_SLOW,this.pos={x:0,y:0},this.matrix=[],this.initializeBlocks=null,this.blocks="",this.blockEventListening=!1};function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}Block.prototype.move=function(e){this.pos.x+=e,this.arena.collide(this)&&(this.pos.x-=e)},Block.prototype.randomizeBlock=function(){this.blocks.length<4&&(this.blocks+=this.initializeBlocks);var e=this.blocks.charAt(0);this.blocks=this.blocks.slice(1),this.matrix=this.createBlock(e);var t=this.createBlock(this.blocks.charAt(0));this.tetris.drawMatrix(t,{x:2===t.length?.5:0,y:4===t.length?1:2},!0),this.pos.y=0,this.pos.x=4,this.events.emit("pos",{x:4,y:1}),this.events.emit("matrix",this.matrix),this.arena.collide(this)&&(this.tetris.draw(),this.events.emit("lost",!0))},Block.prototype.rotate=function(e){var t=this.pos.x,i=1;for(this.rotateMatrix(this.matrix,e);this.arena.collide(this);)if(this.pos.x+=i,(i=-(i+(0<i?1:-1)))>this.matrix[0].length)return this.rotateMatrix(this.matrix,-e),void(this.pos.x=t)},Block.prototype.rotateMatrix=function(e,t){for(var i=0;i<e.length;i+=1)for(var a=0;a<i;a+=1){var n=[e[i][a],e[a][i]];e[a][i]=n[0],e[i][a]=n[1]}if(0<t)for(var r=0;r<e.length;r+=1)e[r].reverse();else e.reverse()},Block.prototype.drop=function(e){for(var t=this;this.pos.y++,this.dropCounter=0,e&&!this.arena.collide(this););this.arena.collide(this)&&(this.pos.y--,this.tetris.draw(),this.arena.merge(this),this.arena.sweepRow(function(){t.randomizeBlock()}))},Block.prototype.update=function(e){this.dropCounter+=e,this.dropCounter>this.dropInterval&&this.drop()},Block.prototype.blockControll=function(){var i=this;if(!this.blockEventListening){this.blockEventListening=!0,document.addEventListener("keydown",function(e){a(e)},!1),document.addEventListener("touchstart",function(e){a(e)},!1),document.addEventListener("mousedown",function(e){a(e)},!1),document.addEventListener("keyup",function(e){t(e)},!1),document.addEventListener("touchend",function(e){t(e)},!1),document.addEventListener("mouseup",function(e){t(e)},!1);var t=function(e){(isNumeric(e.target.id)?parseInt(e.target.id):e.keyCode)===KEY_BINDS.moveDown&&(i.dropInterval=i.DROP_SLOW),e.preventDefault()},a=function(e){if(!i.tetris.stopped){var t=isNumeric(e.target.id)?parseInt(e.target.id):e.keyCode;switch(t){case KEY_BINDS.moveRight:i.move(1);break;case KEY_BINDS.moveLeft:i.move(-1);break;case KEY_BINDS.moveDown:i.dropInterval!==i.DROP_FAST&&null!==i.tetris.stopped&&(i.drop(),i.dropInterval=i.DROP_FAST);break;case KEY_BINDS.rotLeft:i.rotate(-1);break;case KEY_BINDS.rotRight:i.rotate(1);break;case KEY_BINDS.hardDrop:if(document.getElementById("message")===document.activeElement||null===i.tetris.stopped)return;i.drop(!0);break;case KEY_BINDS.special1:case KEY_BINDS.special2:case KEY_BINDS.special3:case KEY_BINDS.special4:case KEY_BINDS.special5:i.tetris.special.useSpecial(t);break;case 74:console.table(i.arena.matrix)}if("localhost:5060"===location.host)switch(t){case 84:break;case 89:i.arena.events.emit("special","add-special",[16]);break;case 72:Math.floor(20*Math.random()+1),Math.floor(9*Math.random()+1),Math.floor(12*Math.random());i.arena.events.emit("special","add-special",[11,11,11]),i.arena.clear(),i.arena.matrix[21].fill(1),i.arena.matrix[20].fill(2),i.arena.matrix[21][0]=0,i.arena.matrix[21][1]=0,i.arena.matrix[20][0]=0,i.arena.matrix[20][1]=0}}}}},Block.prototype.createBlock=function(e){switch(e){case"I":return[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];case"L":return[[0,0,2],[2,2,2],[0,0,0]];case"J":return[[3,0,0],[3,3,3],[0,0,0]];case"O":return[[4,4],[4,4]];case"Z":return[[5,5,0],[0,5,5],[0,0,0]];case"S":return[[0,6,6],[6,6,0],[0,0,0]];case"T":return[[0,7,0],[7,7,7],[0,0,0]]}};var Special=function(e){this.tetris=e,this.element=e.element,this.events=e.arena.events,this.matrix=e.arena.matrix,this.sendingSpecial=!1,this.specialTube=[]};function shuffle(e){var t,i,a;for(t=e.length-1;0<t;t--)i=Math.floor(Math.random()*(t+1)),a=e[t],e[t]=e[i],e[i]=a;return e}Special.prototype.clearSpecials=function(){this.specialTube=[],this.element.querySelector(".specials").innerHTML="",this.element.querySelector(".current-special").innerHTML=""},Special.prototype.updateSpecials=function(e){this.specialTube.push.apply(this.specialTube,e.specials);for(var t=0;t<e.specials.length;t+=1){var i=document.createElement("img");i.src="img/game/specials/"+e.specials[t]+".gif";var a=this.element.querySelector(".specials");a.insertBefore(i,a.firstChild)}this.element.querySelector(".current-special").innerHTML=TETRIS.specialName(this.specialTube[0])},Special.prototype.useSpecial=function(e){if(this.sendingSpecial){var t=document.createElement("li");return t.innerHTML="Wait for last special to be done!",t.className="server-message",void document.getElementById("game_log").appendChild(t)}var i=this.specialTube[0],a=[0,KEY_BINDS.special1,KEY_BINDS.special2,KEY_BINDS.special3,KEY_BINDS.special4,KEY_BINDS.special5].indexOf(e),n=document.getElementsByClassName("client-name")[a-1].getAttribute("data-player");null!=i&&null!=n&&(this.sendingSpecial=!0,16===i&&(this.matrix[0].fill(0),this.matrix[1].fill(0),this.matrix[2].fill(0),this.matrix[3].fill(0),this.matrix[4].fill(0),this.events.emit("matrix",this.matrix)),this.events.emit("special","use-special",[i,n]))},Special.prototype.removeSpecial=function(){this.specialTube.splice(0,1),this.sendingSpecial=!1;var e=this.element.querySelector(".specials");e.removeChild(e.lastChild),this.element.querySelector(".current-special").innerHTML=TETRIS.specialName(this.specialTube[0])},Special.prototype.performSpecial=function(e,t){var i=document.createElement("div");i.className="display-used-special",i.innerHTML=TETRIS.specialName(e.special)+"<span>"+e.clientId+"</span>",this.element.appendChild(i);var a=TETRIS.TilesWidth,n=TETRIS.TilesHeight;switch(setTimeout(function(){i.remove()},1100),e.special){case 8:for(var r=new Array(10),s=0;s<r.length;s+=1)r[s]=Math.floor(7*Math.random()+1);r[Math.floor(Math.random()*r.length+0)]=0,this.matrix.splice(0,1),this.matrix.push(r);break;case 9:var o=this.matrix.splice(n-1,1)[0].fill(0);this.matrix.unshift(o);break;case 10:for(var l=this.matrix.length-1;0<l;l-=1)shuffle(this.matrix[l]);break;case 11:var c=0;e:for(var h=0;h<n;h+=1){for(var m=0;m<a;m+=1)if(0<this.matrix[0][m]){7<h&&(c-=2,this.matrix.unshift(new Array(a).fill(0)),this.matrix.unshift(new Array(a).fill(0)));break e}c++,this.matrix.splice(0,1)}for(var p=this.matrix.length,d=0;d<a;d++){for(var u=[],f=0;f<p;f++){var g=this.matrix[f].shift();u.push(g)}shuffle(this.matrix);for(var v=0;v<p;v++){var y=u.shift();this.matrix[v].push(y)}}for(var x=0;x<this.matrix.length;x++)if(-1===this.matrix[x].indexOf(0))for(var w=0;w<a;w++)if(this.matrix[x][w]<8){this.matrix[x][w]=0;break}for(;c--;)this.matrix.unshift(new Array(a).fill(0));break;case 12:for(var b=this.matrix.length-1;0<b;b-=1)for(var T=0;T<this.matrix[b].length;T+=1)7<this.matrix[b][T]&&(this.matrix[b][T]=Math.floor(7*Math.random()+1));break;case 13:for(var E=this.matrix.length-1;0<E;E-=1){var S=this.matrix[E].length,k=Math.floor(Math.random()*S+0);this.matrix[E][k]=0;var I=Math.floor(Math.random()*S+0);this.matrix[E][I]=0}break;case 14:for(var B=this.matrix.length-1;0<B;B-=1)for(var C=0;C<this.matrix[B].length;C+=1)if(0!==this.matrix[B][C])for(var M=B;M<this.matrix.length;M+=1)0===this.matrix[M][C]&&(this.matrix[M][C]=this.matrix[M-1][C],this.matrix[M-1][C]=0);for(var N=0;N<this.matrix.length;N++)if(-1===this.matrix[N].indexOf(0)){var L=this.matrix.splice(N,1)[0].fill(0);this.matrix.unshift(L)}break;case 15:for(var R=0;R<this.matrix.length;R+=1)this.matrix[R].fill(0);break;case 16:for(var _=this.matrix.length-1;0<=_;_-=1)for(var D=0;D<this.matrix[_].length;D+=1)this.matrix[_][D]=t[_][D];break;case 17:for(var A=8;A<this.matrix.length;A+=1)this.matrix[A].fill(2);this.matrix[0].fill(0),this.matrix[1].fill(0),this.matrix[2].fill(0),this.matrix[3].fill(0),this.matrix[4].fill(0),this.matrix[5].fill(0),this.matrix[6].fill(0),this.matrix[7].fill(0),this.matrix[8][4]=0,this.matrix[8][5]=0,this.matrix[9][2]=0,this.matrix[9][4]=0,this.matrix[9][5]=0,this.matrix[9][7]=0,this.matrix[10][0]=0,this.matrix[10][1]=0,this.matrix[10][2]=0,this.matrix[10][7]=0,this.matrix[10][8]=0,this.matrix[10][9]=0,this.matrix[11][0]=0,this.matrix[11][1]=0,this.matrix[11][8]=0,this.matrix[11][9]=0,this.matrix[12][0]=0,this.matrix[12][9]=0,this.matrix[13][2]=0,this.matrix[13][3]=0,this.matrix[13][6]=0,this.matrix[13][7]=0,this.matrix[14][2]=0,this.matrix[14][3]=0,this.matrix[14][6]=0,this.matrix[14][7]=0,this.matrix[15][2]=0,this.matrix[15][3]=1,this.matrix[15][6]=1,this.matrix[15][7]=0,this.matrix[16][2]=0,this.matrix[16][3]=1,this.matrix[16][6]=1,this.matrix[16][7]=0,this.matrix[17][0]=0,this.matrix[17][9]=0,this.matrix[18][0]=0,this.matrix[18][1]=0,this.matrix[18][8]=0,this.matrix[18][9]=0,this.matrix[19][0]=0,this.matrix[19][1]=0,this.matrix[19][2]=0,this.matrix[19][7]=0,this.matrix[19][8]=0,this.matrix[19][9]=0,this.matrix[20][0]=0,this.matrix[20][1]=0,this.matrix[20][2]=0,this.matrix[20][4]=0,this.matrix[20][5]=0,this.matrix[20][7]=0,this.matrix[20][8]=0,this.matrix[20][9]=0,this.matrix[21][4]=0,this.matrix[21][5]=0;break;case 18:for(var H=this.matrix.length-1;0<H;H-=1)for(var O=0;O<this.matrix[H].length;O+=1)7<this.matrix[H][O]&&(this.matrix[H][O]=19);break;default:console.error("performSpecial "+e)}this.events.emit("matrix",this.matrix)};var Chat=function(n,e){var r=this;this.document=n,this.cm=e,this.events=new Events,this.colors=["#e01313","#3d94f6","orange","#05d005","#ce04ce","#ffffff"];var s=Date.now();n.getElementById("send").addEventListener("click",function(){t()},!1),n.getElementById("message").addEventListener("keypress",function(e){13===e.keyCode&&t()},!1);var t=function(){if(s<Date.now()){s=Date.now()+2e3;var e=n.getElementById("message"),t=e.value.replace(/(<([^>]+)>)/gi,"");if(400<t.length){var i=n.getElementById("messages");i.innerHTML+='<div style="color:#ffff00"><span class="chat-message">Please do not spam</span></div>',i.scrollTop=i.scrollHeight}else if(""!==t){var a={message:t,type:"state-chat"};r.cm.send(a),e.value=""}}}};Chat.prototype.message=function(e){for(var t=0,i=document.getElementsByClassName("arena"),a=0;a<i.length;a+=1){if(i[a].querySelector(".client-name").getAttribute("data-player")===e.clientId)break;t++}var n='<div class="'+e.type+'"><span style="color:'+this.colors[t]+'" >'+e.clientId+":</span> "+e.message+"</div>";document.getElementById("messages").innerHTML+=n;var r=document.getElementById("messages");r.scrollTop=r.scrollHeight},Chat.prototype.serverMessage=function(e){e.class=void 0!==e.class?e.class:"server-message";var t='<div class="'+e.class+'">'+e.msg+"</div>";document.getElementById("messages").innerHTML+=t;var i=document.getElementById("messages");i.scrollTop=i.scrollHeight},document.addEventListener("DOMContentLoaded",function(){"WebSocket"in window&&2===window.WebSocket.CLOSING?new ConnectionManager(document).connect(("https:"===window.location.protocol?"wss://":"ws://")+location.host+"/game"):alert("Your browser dont support websockets! Please change browser");if("localhost:5060"===location.host)SCREEN.resizeViewPort(600,430);else{var e=.8*screen.availHeight,t=e/3+e;SCREEN.resizeViewPort(t,e)}SCREEN.resizeContent()}),window.addEventListener("keydown",function(e){if(e.ctrlKey&&67==e.keyCode){var t=document.getElementById("message");t===document.activeElement?t.blur():t.focus()}},!1),document.getElementById("toggle_fullscreen").onchange=function(e){e.preventDefault(),SCREEN.toggleFullscreen()};